function createType(validator) {
  const type = {
    parse(value) {
      const result = validator(value);
      if (!result.ok) {
        throw new Error(result.error || 'Validation failed');
      }
      return result.value;
    },
    optional() {
      return createType(value => {
        if (value === undefined) {
          return { ok: true, value: undefined };
        }
        return validator(value);
      });
    },
    default(defaultValue) {
      return createType(value => {
        if (value === undefined) {
          return { ok: true, value: typeof defaultValue === 'function' ? defaultValue() : defaultValue };
        }
        return validator(value);
      });
    },
    min(limit) {
      return createType(value => {
        const result = validator(value);
        if (!result.ok) return result;
        const val = result.value;
        if (typeof val === 'string' && val.length < limit) {
          return { ok: false, error: `Expected string length >= ${limit}` };
        }
        if (typeof val === 'number' && val < limit) {
          return { ok: false, error: `Expected number >= ${limit}` };
        }
        return result;
      });
    },
    max(limit) {
      return createType(value => {
        const result = validator(value);
        if (!result.ok) return result;
        const val = result.value;
        if (typeof val === 'string' && val.length > limit) {
          return { ok: false, error: `Expected string length <= ${limit}` };
        }
        if (typeof val === 'number' && val > limit) {
          return { ok: false, error: `Expected number <= ${limit}` };
        }
        return result;
      });
    },
    int() {
      return createType(value => {
        const result = validator(value);
        if (!result.ok) return result;
        const val = result.value;
        if (!Number.isInteger(val)) {
          return { ok: false, error: 'Expected integer' };
        }
        return result;
      });
    },
  };
  return type;
}

function string() {
  return createType(value => {
    if (typeof value === 'string') {
      return { ok: true, value };
    }
    return { ok: false, error: 'Expected string' };
  });
}

function number() {
  return createType(value => {
    if (typeof value === 'number' && Number.isFinite(value)) {
      return { ok: true, value };
    }
    return { ok: false, error: 'Expected number' };
  });
}

function boolean() {
  return createType(value => {
    if (typeof value === 'boolean') {
      return { ok: true, value };
    }
    return { ok: false, error: 'Expected boolean' };
  });
}

function znull() {
  return createType(value => {
    if (value === null) {
      return { ok: true, value: null };
    }
    return { ok: false, error: 'Expected null' };
  });
}

function array(schema) {
  return createType(value => {
    if (!Array.isArray(value)) {
      return { ok: false, error: 'Expected array' };
    }
    const result = [];
    for (let i = 0; i < value.length; i++) {
      try {
        result.push(schema.parse(value[i]));
      } catch (err) {
        return { ok: false, error: `Invalid array item at index ${i}: ${err.message}` };
      }
    }
    return { ok: true, value: result };
  });
}

function object(shape) {
  return createType(value => {
    if (typeof value !== 'object' || value === null || Array.isArray(value)) {
      return { ok: false, error: 'Expected object' };
    }
    const out = { ...value };
    for (const [key, schema] of Object.entries(shape)) {
      try {
        const parsed = schema.parse(value[key]);
        if (parsed === undefined && !(key in value)) {
          delete out[key];
        } else {
          out[key] = parsed;
        }
      } catch (err) {
        return { ok: false, error: `Invalid field "${key}": ${err.message}` };
      }
    }
    return { ok: true, value: out };
  });
}

function union(schemas) {
  return createType(value => {
    const errors = [];
    for (const schema of schemas) {
      try {
        const parsed = schema.parse(value);
        return { ok: true, value: parsed };
      } catch (err) {
        errors.push(err.message);
      }
    }
    return { ok: false, error: errors.join(' | ') || 'No union match' };
  });
}

function record(schema) {
  return createType(value => {
    if (typeof value !== 'object' || value === null || Array.isArray(value)) {
      return { ok: false, error: 'Expected object record' };
    }
    const out = {};
    for (const [key, val] of Object.entries(value)) {
      try {
        out[key] = schema.parse(val);
      } catch (err) {
        return { ok: false, error: `Invalid value for key "${key}": ${err.message}` };
      }
    }
    return { ok: true, value: out };
  });
}

function enumeration(values) {
  const allowed = Array.isArray(values) ? values.slice() : [];
  return createType(value => {
    if (typeof value !== 'string') {
      return { ok: false, error: 'Expected string for enum' };
    }
    if (!allowed.includes(value)) {
      return { ok: false, error: `Expected one of: ${allowed.join(', ')}` };
    }
    return { ok: true, value };
  });
}

function any() {
  return createType(value => ({ ok: true, value }));
}

export const z = {
  object,
  array,
  union,
  record,
  string,
  number,
  boolean,
  null: znull,
  enum: enumeration,
  any,
};

export { object, array, union, record, string, number, boolean, znull as null, enumeration as enum, any };
